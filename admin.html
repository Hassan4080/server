<!doctype html>
<meta charset="utf-8">
<title>Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{--bg:#0b0b0b;--fg:#f2f2f2;--mut:#9aa0a6;--card:#151515;--br:#2a2a2a;--acc:#4da3ff}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{padding:14px 18px;border-bottom:1px solid var(--br);display:grid;gap:10px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input,button{padding:8px 10px;border:1px solid var(--br);border-radius:8px;background:#111;color:#fff}
  button{cursor:pointer}
  button:hover{border-color:#3a3a3a}
  main{padding:18px;display:grid;gap:18px;grid-template-columns:1.2fr 1fr 1fr}
  @media (max-width:1200px){main{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--br);border-radius:12px;overflow:hidden}
  .card h2{margin:0;padding:10px 12px;border-bottom:1px solid var(--br);font-size:15px}
  table{border-collapse:collapse;width:100%}
  th,td{border-top:1px solid var(--br);padding:8px 10px;vertical-align:top}
  th{background:#121212;text-align:left;position:sticky;top:0}
  .mut{color:var(--mut)}
  .rooms{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(360px,1fr));
    gap:14px;
    padding:12px;
    max-height:60vh;
    overflow:auto;
  }
  .room{border:1px solid var(--br);border-radius:10px;background:#101010;display:flex;flex-direction:column;min-height:240px}
  .room-h{padding:8px 10px;background:#121212;border-bottom:1px solid var(--br);display:flex;gap:8px;align-items:center}
  .badge{padding:2px 8px;border-radius:999px;background:#1d2633;color:#bcd7ff;font-size:12px;margin-left:6px}
  .log{
    font:12px/1.5 ui-monospace,SFMono-Regular,Consolas,Menlo,monospace;
    background:#0b0b0b;
    color:#e9e9e9;
    padding:8px 10px;
    overflow:auto;
    white-space:pre-wrap;
    word-break:break-word;
    max-height:220px; /* scroll inside each room */
  }
</style>

<header>
  <div class="row">
    <b>Server:</b>
    <input id="base" placeholder="https://chat-smge.onrender.com" style="min-width:360px">
    <b>CONN_TOKEN:</b>
    <input id="connTok" type="password" placeholder="for /connections.json, /rooms.json">
    <b>LOGS_TOKEN:</b>
    <input id="logsTok" type="password" placeholder="for logs + WS monitor">
    <button id="apply">Apply</button>
    <span class="mut">Poll 2s; connections + logs refreshed by polling.</span>
  </div>
  <div class="row">
    <label>Filter room: <input id="roomFilter" placeholder="(blank = all)"></label>
    <button id="applyFilter">Apply</button>
    <label>Add room: <input id="manualRoom" placeholder="ffa:party:TAG"></label>
    <button id="addRoom">Monitor</button>
  </div>
</header>

<main>
  <!-- Connections -->
  <section class="card">
    <h2>Connections</h2>
    <div style="max-height:60vh;overflow:auto">
      <table id="tbl">
        <thead><tr><th>#</th><th>Room</th><th>Name</th><th>Key</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Logs -->
  <section class="card">
    <h2>Room Logs</h2>
    <div id="rooms" class="rooms"></div>
  </section>

  <!-- Keys -->
  <section class="card">
    <h2>Keys</h2>
    <div style="padding:12px;display:grid;gap:10px">
      <div class="row">
        <b>ADMIN_TOKEN:</b>
        <input id="admTok" type="password" placeholder="paste once (saved locally)" style="min-width:260px">
        <button id="saveAdmin">Save</button>
        <span class="mut">Needed for /admin/keys.</span>
      </div>
      <div class="row">
        <label>Label: <input id="keyLabel" placeholder="e.g. Hasan, Friend-1"></label>
        <button id="genKey">Generate</button>
        <button id="refreshKeys">Refresh</button>
        <input id="keyFilter" placeholder="Filter (label/key)" style="flex:1">
      </div>
      <div style="max-height:50vh;overflow:auto">
        <table>
          <thead><tr><th>Label</th><th>Key</th><th>Status</th><th>Created</th><th>Actions</th></tr></thead>
          <tbody id="keysTbody"></tbody>
        </table>
      </div>
      <div id="keyMsg" class="mut"></div>
    </div>
  </section>
</main>

<script>
/* ---------- basics ---------- */
const base   = document.getElementById('base');
const connEl = document.getElementById('connTok');
const logsEl = document.getElementById('logsTok');
const apply  = document.getElementById('apply');
const filt   = document.getElementById('roomFilter');
const applyF = document.getElementById('applyFilter');
const manual = document.getElementById('manualRoom');
const addBtn = document.getElementById('addRoom');
const tbody  = document.querySelector('#tbl tbody');
const rooms  = document.getElementById('rooms');

const admTok = document.getElementById('admTok');
const saveAdmin = document.getElementById('saveAdmin');
const keyLabel  = document.getElementById('keyLabel');
const genKeyBtn = document.getElementById('genKey');
const refreshBtn= document.getElementById('refreshKeys');
const keyFilter = document.getElementById('keyFilter');
const keysTbody = document.getElementById('keysTbody');
const keyMsg    = document.getElementById('keyMsg');

base.value   = localStorage.getItem('admin_base')   || location.origin;
connEl.value = localStorage.getItem('admin_conn')   || '';
logsEl.value = localStorage.getItem('admin_logs')   || '';
admTok.value = localStorage.getItem('admin_token')  || '';

function httpBase(){ return base.value.replace(/\/+$/,''); }
function httpToWs(b){
  const clean = b.replace(/\/+$/,'');
  if (/^https:\/\//i.test(clean)) return clean.replace(/^https:/,'wss:') + '/chat';
  if (/^http:\/\//i.test(clean))  return clean.replace(/^http:/,'ws:')  + '/chat';
  if (/^wss?:\/\//i.test(clean))  return clean.endsWith('/chat') ? clean : (clean + '/chat');
  return 'ws://' + clean + '/chat';
}

localStorage.setItem('admin_base', base.value);
base.addEventListener('change', ()=> localStorage.setItem('admin_base', base.value));
connEl.addEventListener('change', ()=> localStorage.setItem('admin_conn', connEl.value));
logsEl.addEventListener('change', ()=> localStorage.setItem('admin_logs', logsEl.value));
saveAdmin.onclick = ()=>{
  localStorage.setItem('admin_token', admTok.value);
  keyMsg.textContent='Admin token saved ✔';
  setTimeout(()=>keyMsg.textContent='',1200);
};

/* ---------- connections + rooms ---------- */
const buffers  = new Map();
const hydrated = new Map();
const paused   = new Map();
const MAX = 500;

function card(room){
  let c = document.querySelector(`[data-room="${CSS.escape(room)}"]`);
  if (c) return c;
  c = document.createElement('div');
  c.className='room'; c.dataset.room = room;
  c.innerHTML = `
    <div class="room-h"><b>${room}</b> <span class="badge" data-b="${room}">0</span>
      <span style="margin-left:auto"></span>
      <button data-pause="${room}">Pause</button>
      <button data-clear="${room}">Clear</button>
      <button data-reco="${room}">Refresh</button>
      <button data-pull="${room}">Pull history</button>
      <button data-wipe="${room}">Wipe server logs</button>
    </div>
    <div class="log" data-log="${room}"></div>`;
  rooms.appendChild(c);
  c.querySelector(`[data-pause="${CSS.escape(room)}"]`).onclick = ()=>{
    const val = !paused.get(room);
    paused.set(room, val);
  };
  c.querySelector(`[data-clear="${CSS.escape(room)}"]`).onclick = ()=>{
    buffers.set(room, []); paint(room);
  };
  c.querySelector(`[data-reco="${CSS.escape(room)}"]`).onclick = ()=>{
    hydrate(room, true);
  };
  c.querySelector(`[data-pull="${CSS.escape(room)}"]`).onclick = ()=>{
    hydrate(room, true);
  };
  c.querySelector(`[data-wipe="${CSS.escape(room)}"]`).onclick = async ()=>{
    await fetch(httpBase()+'/logs/clear?room='+encodeURIComponent(room), {
      headers:{'x-logs-token': logsEl.value}, cache:'no-store'
    });
    buffers.set(room,[]); hydrated.set(room,false); paint(room);
  };
  return c;
}

function push(room, m){
  if (!buffers.has(room)) buffers.set(room,[]);
  const a = buffers.get(room);
  a.push(m); if (a.length>MAX) a.splice(0,a.length-MAX);
  if (!paused.get(room)) paint(room);
}

function paint(room) {
  const log = document.querySelector(`[data-log="${CSS.escape(room)}"]`);
  const b   = document.querySelector(`[data-b="${CSS.escape(room)}"]`);
  const arr = buffers.get(room) || [];
  if (b) b.textContent = String(arr.length);
  if (!log) return;

  log.innerHTML = arr.map(x => {
    const raw = x.text || '';
    let time = '';
    let name = '';
    let msg  = raw;

    // pattern: [2025-11-21T11:38:25.582Z] CHAT Hassan: hi
    const m = raw.match(/^\[(.+?)\]\s+CHAT\s+([^:]+):\s*(.*)$/);
    if (m) {
      const iso = m[1];
      const d = new Date(iso);
      if (!isNaN(d)) {
        time = d.toTimeString().slice(0, 8); // HH:MM:SS
      }
      name = m[2];
      msg  = m[3];
    } else {
      // fallback: "CHAT Hassan: hi"
      const m2 = raw.match(/CHAT\s+([^:]+):\s*(.*)$/);
      if (m2) {
        name = m2[1];
        msg  = m2[2];
      } else {
        msg = raw;
      }
    }

    const prefix = time ? `[${time}] ` : '';
    const nameHtml = name ? `<b>${name}</b>` : '';
    return `<div>${prefix}${nameHtml}${nameHtml ? ': ' : ''}${msg}</div>`;
  }).join('');

  log.scrollTop = log.scrollHeight;
}

async function hydrate(room, force=false){
  if (hydrated.get(room) && !force) return;
  try{
    const r = await fetch(httpBase()+'/logs.json?room='+encodeURIComponent(room), {
      headers:{'x-logs-token': logsEl.value}, cache:'no-store'
    });
    const j = await r.json();
    const msgs = (j.messages || []).map(line => {
      // if server stores plain strings, wrap them; if structured, keep
      if (typeof line === 'string') {
        return { ts: Date.now(), from: 'log', text: line };
      }
      return line;
    });
    buffers.set(room, msgs.slice(-MAX));
    hydrated.set(room,true);
    paint(room);
  }catch(e){
    // silent
  }
}

function connect(room){
  card(room);
  hydrate(room, true);
}

/* ---------- polling ---------- */
async function tick(){
  const roomFilter = filt.value.trim();

  // connections table
  try{
    const qs = roomFilter ? ('?room='+encodeURIComponent(roomFilter)) : '';
    const r = await fetch(httpBase()+'/connections.json'+qs, {
      headers:{'x-conn-token': connEl.value}, cache:'no-store'
    });
    const j = await r.json();
    const list = (j.clients || j.connections || []);
    tbody.innerHTML='';
    list.forEach((c,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML =
        `<td>${i+1}</td><td>${c.room||''}</td><td>${c.name||''}</td><td>${c.key||''}</td>`;
      tbody.appendChild(tr);
    });
    document.title = 'Chat Admin ('+ list.length +')';
  }catch(e){
    // ignore
  }

  // rooms list (if /rooms.json exists, otherwise this silently fails)
  try{
    const rr = await fetch(httpBase()+'/rooms.json', {
      headers:{'x-conn-token': connEl.value}, cache:'no-store'
    });
    const jr = await rr.json();
    const set = new Set(jr.rooms || []);
    const f = roomFilter;
    if (f) {
      for (const r of [...set]) if (!r.includes(f)) set.delete(r);
    }
    set.forEach(rm => { card(rm); connect(rm); });
  }catch(e){
    // ignore (you can instead manually monitor rooms)
  }
}

apply.onclick = ()=>{
  hydrated.clear();
  tick();
};
applyF.onclick = tick;
addBtn.onclick = ()=>{
  const rm = manual.value.trim();
  if (!rm) return;
  card(rm);
  connect(rm);
  manual.value='';
};

/* ---------- key admin ---------- */
function admHeaders(){
  return {
    'content-type':'application/json',
    'x-admin-token': (localStorage.getItem('admin_token')||'')
  };
}

async function loadKeys(){
  keysTbody.innerHTML = `<tr><td colspan="5" class="mut">Loading…</td></tr>`;
  try{
    const r = await fetch(httpBase()+'/admin/keys', { headers: admHeaders(), cache:'no-store' });
    if (!r.ok){
      keysTbody.innerHTML = `<tr><td colspan="5" class="mut">Unauthorized (check ADMIN_TOKEN)</td></tr>`;
      return;
    }
    const data = await r.json();
    // server returns { ok, keys: [...] }
    const all = Array.isArray(data) ? data : (data.keys || []);
    const q = keyFilter.value.trim().toLowerCase();
    const rows = q
      ? all.filter(k => (k.label||'').toLowerCase().includes(q) || (k.key||'').includes(q))
      : all;

    if (!rows.length){
      keysTbody.innerHTML = `<tr><td colspan="5" class="mut">No keys</td></tr>`;
      return;
    }
    keysTbody.innerHTML = rows.map(k => `
      <tr>
        <td>${k.label||''}</td>
        <td><code>${k.key}</code></td>
        <td>${k.revoked ? 'revoked' : 'active'}</td>
        <td>${new Date(k.createdAt).toLocaleString()}</td>
        <td>
          ${k.revoked ? '' : `<button data-revoke="${k.key}">Revoke</button>`}
        </td>
      </tr>`).join('');

    keysTbody.querySelectorAll('[data-revoke]').forEach(btn=>{
      btn.onclick = async ()=>{
        const key = btn.getAttribute('data-revoke');
        const r2 = await fetch(httpBase()+'/admin/keys', {
          method:'DELETE', headers: admHeaders(), body: JSON.stringify({ key })
        });
        if (r2.ok){
          keyMsg.textContent = 'Revoked '+key.slice(0,6)+'…';
          loadKeys();
        } else {
          keyMsg.textContent = 'Revoke failed';
        }
        setTimeout(()=> keyMsg.textContent='', 1500);
      };
    });
  }catch(e){
    keysTbody.innerHTML = `<tr><td colspan="5" class="mut">Error loading keys</td></tr>`;
  }
}

genKeyBtn.onclick = async ()=>{
  const label = keyLabel.value.trim();
  const r = await fetch(httpBase()+'/admin/keys', {
    method:'POST', headers: admHeaders(), body: JSON.stringify({ label })
  });
  if (r.ok){
    const j = await r.json();
    const keyStr = j && j.key && j.key.key ? j.key.key : '';
    keyMsg.textContent = 'Generated: '+keyStr;
    keyLabel.value='';
    loadKeys();
  } else {
    keyMsg.textContent = 'Generate failed (check ADMIN_TOKEN)';
  }
  setTimeout(()=> keyMsg.textContent='', 2500);
};

refreshBtn.onclick = loadKeys;
keyFilter.addEventListener('input', loadKeys);

/* ---------- boot ---------- */
setInterval(tick, 2000);
tick();
loadKeys();
</script>
